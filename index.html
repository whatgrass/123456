<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>字義飽和實驗</title>
<link href="https://cdn.jsdelivr.net/npm/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css"/>
<style>
body { font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif; background: #f7f7f9; color: #222; }
.container { max-width: 800px; margin: 0 auto; padding: 20px; }
.stimulus { font-size: 64px; text-align: center; padding: 120px 20px; }
.test .category { text-align: center; font-size: 32px; margin-bottom: 20px; }
.targets { display: flex; justify-content: center; gap: 40px; font-size: 28px; margin-bottom: 14px; }
.prompt { text-align: center; font-size: 16px; color: #555; }
.fixation { font-size: 48px; text-align: center; padding: 120px 20px; }
.summary { max-width: 800px; margin: 0 auto; padding: 20px; text-align: center; }
.summary h2 { margin-bottom: 8px; }
.summary table { width: 100%; border-collapse: collapse; margin-top: 14px; }
.summary th, .summary td { border: 1px solid #ddd; padding: 10px; }
.summary th { background: #f0f0f0; }
.btn { display: inline-block; padding: 10px 18px; border: 1px solid #333; background: #fff; cursor: pointer; margin-top: 18px; }
</style>
</head>
<body>
<div id="jspsych-target" class="container"></div>
<script src="https://cdn.jsdelivr.net/npm/jspsych@7.3.3/dist/index.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@jspsych/plugin-html-keyboard-response@1.1.1/dist/index.browser.js"></script>
<script>
var trial_conditions = [
  { category_word: "花", target1: "牡丹", target2: "玫瑰", correct_response: 'y', condition_type: "飽和-兩是" },
  { category_word: "花", target1: "牡丹", target2: "車子", correct_response: 'n', condition_type: "飽和-一是一否" },
  { category_word: "家具", target1: "桌子", target2: "椅子", correct_response: 'y', condition_type: "控制-兩是" },
  { category_word: "家具", target1: "桌子", target2: "蘋果", correct_response: 'n', condition_type: "控制-一是一否" }
];

var jsPsych = initJsPsych({
  display_element: 'jspsych-target',
  on_finish: function() {
    var trials = jsPsych.data.get().filter({ phase: 'test' });
    var acc = trials.count() ? Math.round(trials.filter({ correct: true }).count() * 100 / trials.count()) : 0;
    var rtMean = Math.round(trials.select('rt').mean() || 0);
    var condStats = {};
    trials.values().forEach(function(d) {
      var k = d.condition_type;
      if (!condStats[k]) condStats[k] = { count: 0, correct: 0, rts: [] };
      condStats[k].count += 1;
      condStats[k].correct += d.correct ? 1 : 0;
      condStats[k].rts.push(d.rt);
    });
    var rows = '';
    Object.keys(condStats).forEach(function(k) {
      var s = condStats[k];
      var a = s.count ? Math.round(s.correct * 100 / s.count) : 0;
      var m = s.rts.length ? Math.round(s.rts.reduce((p, c) => p + c, 0) / s.rts.length) : 0;
      rows += '<tr><td>' + k + '</td><td>' + a + '%</td><td>' + m + ' ms</td></tr>';
    });
    var html = '<div class="summary"><h2>實驗結束</h2><p>整體正確率：' + acc + '%</p><p>平均反應時間：' + rtMean + ' ms</p><table><thead><tr><th>條件</th><th>正確率</th><th>平均RT</th></tr></thead><tbody>' + rows + '</tbody></table><div><button class="btn" onclick="downloadcsv()">下載資料（CSV）</button></div><p style="margin-top:10px;">按任意鍵關閉頁面或重新整理以重跑</p></div>';
    jsPsych.getDisplayElement().innerHTML = html;
  }
});

function downloadcsv() {
  var csv = jsPsych.data.get().csv();
  var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'semantic_satiation_data.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

var welcome = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: '<div style="text-align:center; padding: 60px 20px;"><h2>字義飽和實驗</h2><p style="margin-top:12px;">在每個區塊中，先重複看到主題詞 10 次，接著判斷兩個目標詞是否都屬於該主題詞。</p><p style="margin-top:12px;">按 Y 表示「是」、按 N 表示「否」。</p><p style="margin-top:24px; color:#666;">按任意鍵開始</p></div>',
  choices: 'ALL_KEYS'
};

var block = {
  timeline: [
    {
      timeline: [{
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
          var w = jsPsych.timelineVariable('category_word');
          return '<div class="stimulus">' + w + '</div>';
        },
        choices: 'NO_KEYS',
        trial_duration: 500,
        post_trial_gap: 50
      }],
      repetitions: 10
    },
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        var c = jsPsych.timelineVariable('category_word');
        var t1 = jsPsych.timelineVariable('target1');
        var t2 = jsPsych.timelineVariable('target2');
        return '<div class="test"><div class="category">' + c + '</div><div class="targets"><div>' + t1 + '</div><div>' + t2 + '</div></div><div class="prompt">這兩個詞是否都屬於這個主題？按 Y=是 / N=否</div></div>';
      },
      choices: ['y','n'],
      data: {
        category_word: jsPsych.timelineVariable('category_word'),
        target1: jsPsych.timelineVariable('target1'),
        target2: jsPsych.timelineVariable('target2'),
        correct_response: jsPsych.timelineVariable('correct_response'),
        condition_type: jsPsych.timelineVariable('condition_type'),
        phase: 'test'
      },
      on_finish: function(data) { data.correct = (data.response === data.correct_response); }
    },
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div class="fixation">+</div>',
      choices: 'NO_KEYS',
      trial_duration: 1000
    }
  ],
  timeline_variables: trial_conditions,
  randomize_order: false
};

var end = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: '<div style="text-align:center; padding: 60px 20px;"><p>資料已整理於頁面結束畫面，可下載 CSV 檔。</p><p style="color:#666;">按任意鍵結束</p></div>',
  choices: 'ALL_KEYS'
};

jsPsych.run([welcome, block, end]);
</script>
</body>
</html>